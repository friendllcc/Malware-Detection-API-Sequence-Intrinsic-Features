import os
import json
import numpy as np

paths = ['./goodware_samples/cuckoo_report',
         './malware_samples/cuckoo_report']


def api_extraction():
    paths = ['./goodware_samples/cuckoo_report']

    report_list = []
    api_num = []
    n = 0
    for path in paths:
        file_list = os.listdir(path)
        for file_num in file_list:
            print("{} / 1600".format(n))
            n = n + 1
            if os.path.exists(path + "/" + file_num + "/reports/report.json"):
                with open(path + "/" + file_num + "/reports/report.json", 'r') as load_f:
                    try:
                        report_dict = {}
                        call_list = []
                        load_dict = json.load(load_f)
                        if 'behavior' not in load_dict:
                            continue
                        report_dict['md5'] = load_dict['target']['file']['md5']
                        for process in load_dict['behavior']['processes']:
                            if len(process['calls']) != 0:
                                for call in process['calls']:
                                    call_list.append(call['api'])
                                    # Statistics API
                                    if call['api'] not in api_num:
                                        api_num.append(call['api'])
                        report_dict['call_list'] = call_list
                        report_list.append(report_dict)
                    except:
                        print(path + "/" + file_num + "_error")

        np.savez("goodware_api", report_list=report_list)
        print(len(api_num))